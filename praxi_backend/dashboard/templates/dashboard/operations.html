{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block chart_js %}
<!-- Chart.js f√ºr Operations-Diagramme -->
<script src="{% static 'vendor/chartjs/chart.umd.min.js' %}"></script>
{% endblock %}

{% block title %}Operations-Dashboard{% endblock %}
{% block header_title %}PraxiApp - Operationen{% endblock %}
{% block nav_active_operations %}prx-header__link--active{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'css/pages/haupt_dashboard.css' %}?v=4.0">
{% endblock %}

{% block page_header %}
<section class="prx-section">
    <div class="prx-section__header">
        <div>
            <h1 class="prx-section__title">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false">
                        <path d="M2 21l6-6 9-9 2 2-9 9-6 6H2zM20 4l.7-.7 1.4 1.4L21.4 5.4 20 4z"/>
                    </svg>
                </span>
                Operations-Dashboard
            </h1>
            <p class="prx-section__subtitle">
                Patientenfluss, Ressourcen und OP-Kennzahlen
            </p>
            <div id="ops-chart-debug" class="text-muted text-sm" style="margin-top:6px;"></div>
        </div>
        <div class="prx-flex prx-gap-3">
            <select class="prx-select" id="periodSelect" onchange="window.location.href='?days=' + this.value" style="min-width: 150px;">
                <option value="1" {% if selected_days == 1 %}selected{% endif %}>Heute</option>
                <option value="7" {% if selected_days == 7 %}selected{% endif %}>Woche</option>
                <option value="30" {% if selected_days == 30 %}selected{% endif %}>Monat</option>
            </select>
            <a href="{% url 'dashboard:index' %}" class="prx-btn prx-btn--secondary">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </span>
                Zur√ºck
            </a>
            <button class="prx-btn prx-btn--primary" onclick="location.reload()">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                </span>
                Aktualisieren
            </button>
        </div>
    </div>
</section>
{% endblock %}

{% block kpi_section %}
<section class="prx-kpi-grid">
    <div class="prx-kpi prx-kpi--primary">
        <div class="prx-kpi__header">
            <span class="prx-kpi__icon">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2 21l6-6 9-9 2 2-9 9-6 6H2zM20 4l.7-.7 1.4 1.4L21.4 5.4 20 4z"/>
                    </svg>
                </span>
            </span>
            <div>
                <div class="prx-kpi__label">
                    Operationen
                    <span
                        class="prx-info-btn"
                        role="button"
                        tabindex="0"
                        data-title="Operationen"
                        data-info="Gesamtzahl der Operationen im Zeitraum."
                        data-detail="Alle OPs zwischen den angezeigten Daten."
                        aria-label="Info zu Operationen"
                    >i</span>
                </div>
                <div class="prx-kpi__value">{{ utilization.total_operations|default:"0" }}</div>
                <div class="prx-kpi__description">{{ period.from|date:"d.m.Y" }} ‚Äì {{ period.to|date:"d.m.Y" }}</div>
            </div>
        </div>
    </div>
    <div class="prx-kpi prx-kpi--success">
        <div class="prx-kpi__header">
            <span class="prx-kpi__icon">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                    </svg>
                </span>
            </span>
            <div>
                <div class="prx-kpi__label">
                    Abgeschlossen
                    <span
                        class="prx-info-btn"
                        role="button"
                        tabindex="0"
                        data-title="Abgeschlossen"
                        data-info="Anzahl abgeschlossener Operationen."
                        data-detail="Nur OPs mit Status abgeschlossen im Zeitraum."
                        aria-label="Info zu Abgeschlossen"
                    >i</span>
                </div>
                <div class="prx-kpi__value">{{ throughput.completed|default:"0" }}</div>
                <div class="prx-kpi__description">{{ throughput.completion_rate|default:"0" }}% Abschlussquote</div>
            </div>
        </div>
    </div>
    <div class="prx-kpi prx-kpi--warning">
        <div class="prx-kpi__header">
            <span class="prx-kpi__icon">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                    </svg>
                </span>
            </span>
            <div>
                <div class="prx-kpi__label">
                    In Bearbeitung
                    <span
                        class="prx-info-btn"
                        role="button"
                        tabindex="0"
                        data-title="In Bearbeitung"
                        data-info="OPs im laufenden Status."
                        data-detail="Operationen, die aktuell bearbeitet werden."
                        aria-label="Info zu In Bearbeitung"
                    >i</span>
                </div>
                <div class="prx-kpi__value">{{ utilization.in_progress|default:"0" }}</div>
            </div>
        </div>
    </div>
    <div class="prx-kpi prx-kpi--info">
        <div class="prx-kpi__header">
            <span class="prx-kpi__icon">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                    </svg>
                </span>
            </span>
            <div>
                <div class="prx-kpi__label">
                    √ò OP-Dauer
                    <span
                        class="prx-info-btn"
                        role="button"
                        tabindex="0"
                        data-title="√ò OP-Dauer"
                        data-info="Durchschnittliche OP-Dauer."
                        data-detail="Mittlere Dauer aller Operationen im Zeitraum."
                        aria-label="Info zu √ò OP-Dauer"
                    >i</span>
                </div>
                <div class="prx-kpi__value">{{ throughput.avg_duration_minutes|default:"0" }}<span class="prx-kpi__unit">min</span></div>
            </div>
        </div>
    </div>
    <div class="prx-kpi prx-kpi--mint">
        <div class="prx-kpi__header">
            <span class="prx-kpi__icon">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 11h18v9a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-9zM7 7h10v4H7V7zM12 2l4 3h-3v2h-2V5H8l4-3z"/>
                    </svg>
                </span>
            </span>
            <div>
                <div class="prx-kpi__label">
                    Raum-Auslastung
                    <span
                        class="prx-info-btn"
                        role="button"
                        tabindex="0"
                        data-title="Raum-Auslastung"
                        data-info="Auslastung der OP-Raeume."
                        data-detail="Belegte OP-Zeit im Verhaeltnis zur Verfuegbarkeit."
                        aria-label="Info zu Raum-Auslastung"
                    >i</span>
                </div>
                <div class="prx-kpi__value">{{ utilization.room_utilization_percent|default:"0" }}<span class="prx-kpi__unit">%</span></div>
            </div>
        </div>
    </div>
    <div class="prx-kpi prx-kpi--{% if punctuality.rate >= 90 %}success{% elif punctuality.rate >= 70 %}warning{% else %}danger{% endif %}">
        <div class="prx-kpi__header">
            <span class="prx-kpi__icon">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                    </svg>
                </span>
            </span>
            <div>
                <div class="prx-kpi__label">
                    P√ºnktlichkeit
                    <span
                        class="prx-info-btn"
                        role="button"
                        tabindex="0"
                        data-title="P√ºnktlichkeit"
                        data-info="Anteil puenktlicher OPs."
                        data-detail="Misst, wie viele OPs ohne Verzoegerung starten."
                        aria-label="Info zu P√ºnktlichkeit"
                    >i</span>
                </div>
                <div class="prx-kpi__value">{{ punctuality.rate|default:"0" }}<span class="prx-kpi__unit">%</span></div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<!-- Patient Flow Pipeline -->
<section class="prx-section">
    <div class="prx-card">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">
                <span class="prx-card__title-icon">üö∂</span>
                Patientenfluss Live
            </h3>
            <span
                class="prx-info-btn"
                role="button"
                tabindex="0"
                data-title="Patientenfluss Live"
                data-info="Aktueller Status der Patienten im OP-Prozess."
                data-detail="Zeigt die Verteilung in den Phasen: angemeldet, warten, Vorbereitung, Behandlung, Nachbereitung, abgeschlossen."
                aria-label="Info zu Patientenfluss Live"
            >i</span>
        </div>
        <div class="prx-card__body">
            <div class="flow-pipeline">
                {% for status in patient_flow.statuses %}
                <div class="flow-stage" style="background: {{ status.color }};">
                    <div class="flow-count">{{ status.count }}</div>
                    <div class="flow-label">{{ status.label }}</div>
                </div>
                {% empty %}
                <p class="text-muted">Keine Patientenfluss-Daten</p>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<!-- Main Content Grid -->
<div class="prx-content-grid">
    <!-- St√ºndliche Verteilung -->
    <div class="prx-card prx-span-2">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">
                <span class="prx-card__title-icon">üìà</span>
                St√ºndliche Verteilung
            </h3>
            <div style="display: inline-flex; align-items: center; gap: var(--spacing-2);">
                <span class="prx-badge prx-badge--info">Peak: {{ hourly.peak_hour }}:00 Uhr</span>
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="St√ºndliche Verteilung"
                    data-info="Verteilung der OPs √ºber den Tag."
                    data-detail="Zeigt, in welchen Stunden die meisten OPs stattfinden."
                    aria-label="Info zur St√ºndlichen Verteilung"
                >i</span>
            </div>
        </div>
        <div class="prx-card__body">
            <div class="prx-chart-container prx-chart-container--md">
                <div class="text-muted text-sm prx-text-center prx-chart-placeholder">Diagramm l√§dt‚Ä¶</div>
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Durchlaufzeiten -->
    <div class="prx-card">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">
                <span class="prx-card__title-icon">‚è±Ô∏è</span>
                Durchlaufzeiten
            </h3>
            <span
                class="prx-info-btn"
                role="button"
                tabindex="0"
                data-title="Durchlaufzeiten"
                data-info="Durchschnittliche Zeiten je Prozessschritt."
                data-detail="Wartezeit, Vorbereitung, Behandlung und Nachbereitung in Minuten."
                aria-label="Info zu Durchlaufzeiten"
            >i</span>
        </div>
        <div class="prx-card__body">
            <div class="flow-times-grid">
                <div class="flow-time-item" style="background: var(--color-warning-50);">
                    <div class="flow-time-value" style="color: var(--color-warning-600);">{{ flow_times.avg_wait_time|default:"0" }}</div>
                    <div class="flow-time-label">Wartezeit (min)</div>
                </div>
                <div class="flow-time-item" style="background: var(--color-info-50);">
                    <div class="flow-time-value" style="color: var(--color-info-600);">{{ flow_times.avg_prep_time|default:"0" }}</div>
                    <div class="flow-time-label">Vorbereitung</div>
                </div>
                <div class="flow-time-item" style="background: var(--color-success-50);">
                    <div class="flow-time-value" style="color: var(--color-success-600);">{{ flow_times.avg_treatment_time|default:"0" }}</div>
                    <div class="flow-time-label">Behandlung</div>
                </div>
                <div class="flow-time-item" style="background: var(--color-primary-50);">
                    <div class="flow-time-value" style="color: var(--color-primary-600);">{{ flow_times.avg_post_time|default:"0" }}</div>
                    <div class="flow-time-label">Nachbereitung</div>
                </div>
            </div>
            <div class="prx-text-center text-sm font-semibold" style="margin-top: var(--space-4); padding: var(--space-3); background: var(--color-neutral-100); border-radius: var(--radius-lg);">
                √ò Gesamtdauer: {{ flow_times.avg_total_time|default:"0" }} min
            </div>
        </div>
    </div>

    <!-- Ressourcen-Auslastung -->
    <div class="prx-card prx-span-2">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">
                <span class="prx-card__title-icon">üè•</span>
                Ressourcen-Auslastung
            </h3>
            <span
                class="prx-info-btn"
                role="button"
                tabindex="0"
                data-title="Ressourcen-Auslastung"
                data-info="Auslastung aller Ressourcen."
                data-detail="Uebersicht der Auslastung je Raum und Geraet."
                aria-label="Info zu Ressourcen-Auslastung"
            >i</span>
        </div>
        <div class="prx-card__body">
            <div class="prx-table-wrapper">
                <table class="prx-table">
                    <thead>
                        <tr>
                            <th>Ressource</th>
                            <th>Typ</th>
                            <th>Auslastung</th>
                            <th>Stunden</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for resource in resources.resources %}
                        <tr>
                            <td>
                                <span class="flex items-center gap-2">
                                    <span style="width: 10px; height: 10px; border-radius: 50%; background: {{ resource.color }};"></span>
                                    {{ resource.name }}
                                </span>
                            </td>
                            <td>{% if resource.type == 'room' %}üö™ Raum{% else %}üîß Ger√§t{% endif %}</td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <div class="prx-progress" style="width: 100px;">
                                        <div class="prx-progress__bar" style="width: {{ resource.utilization }}%; background: {% if resource.utilization >= 80 %}var(--color-danger-500){% elif resource.utilization >= 60 %}var(--color-warning-500){% else %}var(--color-success-500){% endif %};"></div>
                                    </div>
                                    <span class="font-semibold">{{ resource.utilization }}%</span>
                                </div>
                            </td>
                            <td>{{ resource.booked_hours }}h</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="prx-text-center text-muted">Keine Ressourcen</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Engpass-Analyse -->
    <div class="prx-card">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">
                <span class="prx-card__title-icon">üö®</span>
                Engpass-Analyse
            </h3>
            <span
                class="prx-info-btn"
                role="button"
                tabindex="0"
                data-title="Engpass-Analyse"
                data-info="Faktoren, die Engpaesse verursachen."
                data-detail="Bewertet Ressourcen, No-Show und Stornoquote als Einflussfaktoren."
                aria-label="Info zu Engpass-Analyse"
            >i</span>
        </div>
        <div class="prx-card__body">
            <div class="prx-text-center mb-4">
                <div class="bottleneck-badge {{ bottleneck.category|default:'low' }}">
                    {{ bottleneck.index|default:"‚Äî" }} ‚Äì {{ bottleneck.label|default:"Keine Engp√§sse" }}
                </div>
            </div>
            
            {% if bottleneck.contributing_factors %}
            <h4 class="text-xs text-muted mb-2" style="text-transform: uppercase; letter-spacing: 0.5px;">Einflussfaktoren:</h4>
            {% for factor in bottleneck.contributing_factors %}
            <div style="margin-bottom: var(--space-3);">
                <div class="flex justify-between text-sm mb-1">
                    <span>{{ factor.name }}</span>
                    <span class="font-semibold">{{ factor.score }}</span>
                </div>
                <div class="prx-progress">
                    <div class="prx-progress__bar" style="width: {{ factor.score }}%; background: {% if factor.score >= 70 %}var(--color-danger-500){% elif factor.score >= 40 %}var(--color-warning-500){% else %}var(--color-success-500){% endif %};"></div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
            
            {% if bottleneck.high_util_resources %}
            <h4 class="text-xs text-muted mb-2" style="text-transform: uppercase; letter-spacing: 0.5px; margin-top: var(--space-4);">Hochausgelastete Ressourcen:</h4>
            <div class="flex gap-2 flex-wrap">
                {% for r in bottleneck.high_util_resources %}
                <span class="prx-badge prx-badge--danger">{{ r.name }} ({{ r.utilization }}%)</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Status Charts Row -->
    <div class="prx-card">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">üìä Status-Verteilung</h3>
            <span
                class="prx-info-btn"
                role="button"
                tabindex="0"
                data-title="Status-Verteilung"
                data-info="Verteilung der OP-Status."
                data-detail="Zeigt Anteile pro Status (geplant, in Arbeit, abgeschlossen)."
                aria-label="Info zu Status-Verteilung"
            >i</span>
        </div>
        <div class="prx-card__body">
            <div class="prx-chart-container prx-chart-container--sm">
                <div class="text-muted text-sm prx-text-center prx-chart-placeholder">Diagramm l√§dt‚Ä¶</div>
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <div class="prx-card">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">‚è∞ P√ºnktlichkeit</h3>
            <span
                class="prx-info-btn"
                role="button"
                tabindex="0"
                data-title="P√ºnktlichkeit"
                data-info="Puenktliche Starts vs. Verzoegerungen."
                data-detail="Vergleicht geplante und tatsaechliche Startzeiten."
                aria-label="Info zu P√ºnktlichkeit (Chart)"
            >i</span>
        </div>
        <div class="prx-card__body">
            <div class="prx-chart-container prx-chart-container--sm">
                <div class="text-muted text-sm prx-text-center prx-chart-placeholder">Diagramm l√§dt‚Ä¶</div>
                <canvas id="punctualityChart"></canvas>
            </div>
        </div>
    </div>

    <div class="prx-card">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">üìù Dokumentation</h3>
            <span
                class="prx-info-btn"
                role="button"
                tabindex="0"
                data-title="Dokumentation"
                data-info="Erfasste vs. fehlende Dokumentation."
                data-detail="Zeigt, wie viele OPs vollstaendig dokumentiert sind."
                aria-label="Info zu Dokumentation"
            >i</span>
        </div>
        <div class="prx-card__body">
            <div class="prx-chart-container prx-chart-container--sm">
                <div class="text-muted text-sm prx-text-center prx-chart-placeholder">Diagramm l√§dt‚Ä¶</div>
                <canvas id="documentationChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Daily Trend -->
    <div class="prx-card prx-span-full">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">
                <span class="prx-card__title-icon">üìà</span>
                T√§glicher Trend
            </h3>
            <span
                class="prx-info-btn"
                role="button"
                tabindex="0"
                data-title="T√§glicher Trend"
                data-info="Trend der OP-Kennzahlen pro Tag."
                data-detail="Zeigt Verlauf der wichtigsten OP-Kennzahlen im Zeitfenster."
                aria-label="Info zu T√§glicher Trend"
            >i</span>
        </div>
        <div class="prx-card__body">
            <div class="prx-chart-container prx-chart-container--md">
                <div class="text-muted text-sm prx-text-center prx-chart-placeholder">Diagramm l√§dt‚Ä¶</div>
                <canvas id="dailyTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Room Heatmap -->
    <div class="prx-card prx-span-2">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">
                <span class="prx-card__title-icon">üî•</span>
                Raum-Heatmap
            </h3>
            <span
                class="prx-info-btn"
                role="button"
                tabindex="0"
                data-title="Raum-Heatmap"
                data-info="Heatmap der Raumbelegung."
                data-detail="Dunklere Felder bedeuten hoeher ausgelastete Zeiten."
                aria-label="Info zu Raum-Heatmap"
            >i</span>
        </div>
        <div class="prx-card__body">
            {% if charts.room_heatmap.rooms %}
            {% with room=charts.room_heatmap.rooms.0 %}
            <h4 class="text-sm font-medium mb-3">
                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: {{ room.room_color }}; margin-right: 0.5rem;"></span>
                {{ room.room_name }}
            </h4>
            <div class="heatmap-container">
                <table class="heatmap-table">
                    <thead>
                        <tr>
                            <th></th>
                            {% for hour in charts.room_heatmap.hours %}
                            <th>{{ hour }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in room.data %}
                        <tr>
                            <th class="font-semibold">{{ row.day }}</th>
                            {% for cell in row.hours %}
                            <td>
                                <div class="heatmap-cell" style="background: rgba(79, 179, 191, {{ cell.intensity }}%);">
                                    {% if cell.count > 0 %}{{ cell.count }}{% endif %}
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endwith %}
            {% else %}
            <p class="text-muted prx-text-center">Keine Heatmap-Daten verf√ºgbar</p>
            {% endif %}
        </div>
    </div>

    <!-- Top Services -->
    <div class="prx-card">
        <div class="prx-card__header">
            <h3 class="prx-card__title">
                <span class="prx-card__title-icon">üìã</span>
                Top Leistungen
            </h3>
        </div>
        <div class="prx-card__body" style="max-height: 300px; overflow-y: auto;">
            <div class="prx-table-wrapper" style="border: none;">
                <table class="prx-table prx-table--compact">
                    <thead>
                        <tr>
                            <th>Ziffer</th>
                            <th class="prx-table__cell--right">Anz.</th>
                            <th class="prx-table__cell--right">Punkte</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service in services|slice:":10" %}
                        <tr>
                            <td class="prx-table__cell--mono font-semibold" style="color: var(--color-primary-500);">{{ service.code }}</td>
                            <td class="prx-table__cell--right">{{ service.count }}</td>
                            <td class="prx-table__cell--right">{{ service.total_points }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="prx-text-center text-muted">Keine Leistungen</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block inline_scripts %}
<script type="application/json" id="prx-operations-charts-data">{{ charts_json|default:"{}"|safe }}</script>
<script>
    const _readJson = (id, fallback) => {
        const el = document.getElementById(id);
        if (!el) return fallback;
        try {
            return JSON.parse(el.textContent || '');
        } catch (e) {
            return fallback;
        }
    };

    const runCharts = () => {
    const debugEl = document.getElementById('ops-chart-debug');
    document.querySelectorAll('.prx-chart-placeholder').forEach((el) => {
        if (!el.dataset.touched) {
            el.dataset.touched = '1';
            el.textContent = 'Charts initialisieren‚Ä¶';
        }
    });
    const renderMessage = (canvasId, message) => {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const container = canvas.parentElement;
        if (!container) return;
        const ph = container.querySelector('.prx-chart-placeholder');
        if (ph) {
            ph.textContent = message;
            return;
        }
        container.innerHTML = `<div class="text-muted text-sm prx-text-center prx-chart-placeholder">${message}</div>`;
    };

    const clearPlaceholder = (canvasId) => {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const container = canvas.parentElement;
        if (!container) return;
        const ph = container.querySelector('.prx-chart-placeholder');
        if (ph) ph.remove();
    };
    const chartsData = _readJson('prx-operations-charts-data', {});
    if (debugEl) {
        const keys = Object.keys(chartsData || {});
        debugEl.textContent = `Chart.js: ${window.Chart ? 'ok' : 'missing'} | keys: ${keys.join(', ') || 'none'}`;
    }
    const palette = (window.PRX_COLORS && window.PRX_COLORS.palette && window.PRX_COLORS.palette.length)
        ? window.PRX_COLORS.palette
        : ['#4A90E2', '#7ED6C1', '#6FCF97', '#F2C94C', '#EB5757'];
    const paletteLight = (window.PRX_COLORS && window.PRX_COLORS.paletteLight && window.PRX_COLORS.paletteLight.length)
        ? window.PRX_COLORS.paletteLight
        : ['rgba(74,144,226,0.12)', 'rgba(126,214,193,0.12)', 'rgba(111,207,151,0.12)', 'rgba(242,201,76,0.12)', 'rgba(235,87,87,0.12)'];

    try {

    if (!window.Chart) {
        ['hourlyChart', 'statusChart', 'punctualityChart', 'documentationChart', 'dailyTrendChart'].forEach((id) => {
            renderMessage(id, 'Chart.js nicht geladen');
        });
        return;
    }
    
    // St√ºndliche Verteilung
    if (!chartsData.hourly_distribution || !chartsData.hourly_distribution.labels || !chartsData.hourly_distribution.labels.length) {
        renderMessage('hourlyChart', 'Keine Daten verf√ºgbar');
    } else if (window.Chart) {
        chartsData.hourly_distribution.datasets.forEach((ds, i) => {
            ds.backgroundColor = palette[i % palette.length];
        });
        
        clearPlaceholder('hourlyChart');
        new Chart(document.getElementById('hourlyChart'), {
            type: 'bar',
            data: chartsData.hourly_distribution,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top', labels: { boxWidth: 12 } } },
                scales: {
                    y: { beginAtZero: true, stacked: true, grid: { color: PRX_COLORS.neutralLight } },
                    x: { stacked: true, grid: { display: false } }
                }
            }
        });
    }
    
    // Status-Verteilung
    if (!chartsData.status_distribution || !chartsData.status_distribution.labels || !chartsData.status_distribution.labels.length) {
        renderMessage('statusChart', 'Keine Daten verf√ºgbar');
    } else if (window.Chart) {
        chartsData.status_distribution.datasets[0].backgroundColor = [
            PRX_COLORS.success, PRX_COLORS.warning, PRX_COLORS.accent, PRX_COLORS.neutralMedium
        ];
        
        clearPlaceholder('statusChart');
        new Chart(document.getElementById('statusChart'), {
            type: 'doughnut',
            data: chartsData.status_distribution,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8 } } }
            }
        });
    }
    
    // P√ºnktlichkeit
    if (!chartsData.punctuality || !chartsData.punctuality.labels || !chartsData.punctuality.labels.length) {
        renderMessage('punctualityChart', 'Keine Daten verf√ºgbar');
    } else if (window.Chart) {
        chartsData.punctuality.datasets[0].backgroundColor = [
            PRX_COLORS.success, PRX_COLORS.warning, PRX_COLORS.danger
        ];
        
        clearPlaceholder('punctualityChart');
        new Chart(document.getElementById('punctualityChart'), {
            type: 'doughnut',
            data: chartsData.punctuality,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8 } } }
            }
        });
    }
    
    // Dokumentation
    if (!chartsData.documentation || !chartsData.documentation.labels || !chartsData.documentation.labels.length) {
        renderMessage('documentationChart', 'Keine Daten verf√ºgbar');
    } else if (window.Chart) {
        chartsData.documentation.datasets[0].backgroundColor = [
            PRX_COLORS.success, PRX_COLORS.danger
        ];
        
        clearPlaceholder('documentationChart');
        new Chart(document.getElementById('documentationChart'), {
            type: 'doughnut',
            data: chartsData.documentation,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8 } } }
            }
        });
    }
    
    // T√§glicher Trend
    if (!chartsData.daily_trend || !chartsData.daily_trend.labels || !chartsData.daily_trend.labels.length) {
        renderMessage('dailyTrendChart', 'Keine Daten verf√ºgbar');
    } else if (window.Chart) {
        chartsData.daily_trend.datasets.forEach((ds, i) => {
            ds.borderColor = palette[i % palette.length];
            ds.backgroundColor = paletteLight[i % paletteLight.length];
            ds.fill = true;
        });
        
        clearPlaceholder('dailyTrendChart');
        new Chart(document.getElementById('dailyTrendChart'), {
            type: 'line',
            data: chartsData.daily_trend,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top', labels: { boxWidth: 12 } } },
                scales: {
                    y: { beginAtZero: true, grid: { color: PRX_COLORS.neutralLight } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    } catch (e) {
        ['hourlyChart', 'statusChart', 'punctualityChart', 'documentationChart', 'dailyTrendChart'].forEach((id) => {
            renderMessage(id, 'Chart-Fehler');
        });
        console.error('[Operations Charts] Fehler beim Rendern:', e);
    }
    };

    if (document.readyState === 'complete') {
        runCharts();
    } else {
        window.addEventListener('load', runCharts);
    }
</script>
{% endblock %}
