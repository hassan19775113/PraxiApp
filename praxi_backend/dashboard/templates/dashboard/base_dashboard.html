{% load static %}
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light only">
    <title>{% block title %}Dashboard{% endblock %} | PraxiApp</title>
    
    <!-- Favicon -->
    <link rel="icon" href="{% static 'favicon.ico' %}">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PraxiApp Modern Design System -->
    <link rel="stylesheet" href="{% static 'css/design-tokens-modern.css' %}?v=4.0">
    <link rel="stylesheet" href="{% static 'css/base-modern.css' %}?v=4.0">
    <link rel="stylesheet" href="{% static 'css/components-modern.css' %}?v=4.0">
    
    <!-- Legacy Base CSS (Fallback) -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}?v=3.2">
    
    <!-- Page-Specific Styles (loaded in child templates) -->
    {% block page_css %}{% endblock %}

    <style>
      .prx-info-btn {
        background: #fff;
        border: 1px solid var(--border-subtle);
        border-radius: 999px;
        width: 22px;
        height: 22px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--color-text);
        position: relative;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
      }
      .prx-kpi,
      .prx-kpi__header,
      .prx-kpi__label {
        overflow: visible;
      }
      .prx-kpi__label {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .prx-kpi__label .prx-info-btn {
        width: 18px;
        height: 18px;
        font-size: 10px;
      }
      .prx-info-tooltip {
        position: fixed;
        background: #0f172a;
        color: #fff;
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 11px;
        max-width: 240px;
        white-space: normal;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
        pointer-events: none;
        z-index: 100000;
        opacity: 0;
        transform: translateY(4px);
        transition: opacity 0.12s ease, transform 0.12s ease;
      }
      .prx-info-tooltip.is-visible {
        opacity: 1;
        transform: translateY(0);
      }
    </style>
    
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
    
    <!-- Chart.js (nur laden, wenn benötigt) -->
    {% block chart_js %}{% endblock %}
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Header -->
    <header class="prx-header">
        <div class="prx-header__content">
            <div class="prx-header__title">
                <span class="prx-header__title-icon" aria-hidden>
                    <!-- Hospital icon (simple Fluent-like SVG) -->
                    <span class="fluent-icon" aria-hidden>
                        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false">
                            <path d="M3 11h18v9a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-9zM7 7h10v4H7V7zM12 2l4 3h-3v2h-2V5H8l4-3z"/>
                        </svg>
                    </span>
                </span>
                <span>{% block header_title %}PraxiApp - Haupt-Dashboard{% endblock %}</span>
            </div>
            
            <nav class="prx-header__nav" role="navigation" aria-label="Hauptnavi">
                <a href="/praxi_backend/Dashboardadministration/" class="prx-header__link {% block nav_active_main %}{% endblock %}">
                    <span class="fluent-icon" aria-hidden>
                        <!-- Chart icon -->
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h2v18H3V3zm5 6h2v12H8V9zm5-4h2v16h-2V5zm5 8h2v8h-2v-8z"/></svg>
                    </span>
                    <span class="prx-nav-label">Dashboards</span>
                </a>
                <a href="{% url 'dashboard:appointments_calendar' %}" class="prx-header__link {% block nav_active_scheduling %}{% endblock %}">
                    <span class="fluent-icon" aria-hidden>
                        <!-- Calendar icon -->
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10h5v5H7v-5zm0 7h5v2H7v-2zM3 5h2V3h2v2h8V3h2v2h2a1 1 0 0 1 1 1v3H2V6a1 1 0 0 1 1-1z"/></svg>
                    </span>
                    <span class="prx-nav-label">Terminplanung</span>
                </a>
                <a href="{% url 'dashboard:patients' %}" class="prx-header__link {% block nav_active_patients %}{% endblock %}">
                    <span class="fluent-icon" aria-hidden>
                        <!-- People icon -->
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3 1.3 3 3 3zM7 11c1.7 0 3-1.3 3-3S8.7 5 7 5 4 6.3 4 8s1.3 3 3 3zm0 2c-2.3 0-7 1.2-7 3.5V20h14v-3.5C14 14.2 9.3 13 7 13zm9 0c-.3 0-.7 0-1 .1 1.1.9 1.8 2 1.8 3.4V20h6v-3.5C22 14.2 17.3 13 16 13z"/></svg>
                    </span>
                    <span class="prx-nav-label">Patienten</span>
                </a>
                <a href="{% url 'dashboard:doctors' %}" class="prx-header__link {% block nav_active_doctors %}{% endblock %}">
                    <span class="fluent-icon" aria-hidden>
                        <!-- Doctor/clinician icon -->
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a4 4 0 100-8 4 4 0 000 8zm-6 8v-1c0-2.8 3.6-4 6-4s6 1.2 6 4v1H6z"/></svg>
                    </span>
                    <span class="prx-nav-label">Ärzte</span>
                </a>
                <a href="{% url 'dashboard:operations' %}" class="prx-header__link {% block nav_active_operations %}{% endblock %}">
                    <span class="fluent-icon" aria-hidden>
                        <!-- Operation / scalpel icon (simple) -->
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l6-6 9-9 2 2-9 9-6 6H2zM20 4l0.7-0.7 1.4 1.4L21.4 5.4 20 4z"/></svg>
                    </span>
                    <span class="prx-nav-label">Operationen</span>
                </a>
                <a href="{% url 'dashboard:resources' %}" class="prx-header__link {% block nav_active_resources %}{% endblock %}">
                    <span class="fluent-icon" aria-hidden>
                        <!-- Resources / rooms icon -->
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v18H3V3zm4 4h2v10H7V7zm5-4h2v14h-2V3zm5 8h2v6h-2v-6z"/></svg>
                    </span>
                    <span class="prx-nav-label">Ressourcen</span>
                </a>

                <span class="prx-header__sep" aria-hidden>|</span>

                <a href="/admin/" class="prx-header__link">
                    <span class="fluent-icon" aria-hidden>
                        <!-- Gear / admin -->
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.4 12.9c.04-.3.06-.6.06-.9s-.02-.6-.06-.9l2.1-1.6c.19-.15.24-.42.12-.64l-2-3.5c-.12-.22-.38-.3-.6-.22l-2.5 1a7.7 7.7 0 0 0-1.56-.9l-.38-2.7A.5.5 0 0 0 13.4 2h-4.8a.5.5 0 0 0-.5.42l-.38 2.7c-.55.22-1.06.5-1.56.9l-2.5-1a.5.5 0 0 0-.6.22l-2 3.5a.5.5 0 0 0 .12.64L4.6 11.1c-.04.3-.06.6-.06.9s.02.6.06.9l-2.1 1.6a.5.5 0 0 0-.12.64l2 3.5c.12.22.38.3.6.22l2.5-1c.5.4 1.01.72 1.56.94l.38 2.7c.05.24.25.43.5.43h4.8c.25 0 .45-.19.5-.43l.38-2.7c.55-.22 1.06-.53 1.56-.94l2.5 1c.23.09.48 0 .6-.22l2-3.5a.5.5 0 0 0-.12-.64L19.4 12.9zM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7z"/></svg>
                    </span>
                    <span class="prx-nav-label">Admin</span>
                </a>
            </nav>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="prx-main">
        {% block page_header %}{% endblock %}
        {% block kpi_section %}{% endblock %}
        {% block content %}{% endblock %}
    </main>
    
    {% block footer %}{% endblock %}
    
    <!-- FullCalendar JS - MUSS VOR appointment-calendar.js geladen werden -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales-all.global.min.js'></script>
    <script src="{% static 'js/prx_colors.js' %}"></script>

    
    {% block legacy_calendar_scripts %}{% endblock %}
    
    {% block extra_scripts %}{% endblock %}
    
    <!-- Chart.js Defaults - PRX_COLORS Fallback -->
    <script>
      // PRX_COLORS Fallback: Definiere globale Variable, falls nicht bereits vorhanden
      (function(){
        // Wenn PRX_COLORS bereits existiert, nichts tun
        if (typeof window.PRX_COLORS !== 'undefined' && window.PRX_COLORS) {
          return;
        }

        // Helper: Lese CSS-Variable mit Fallback
        const cssVar = (name, fallback) => {
          try {
            const style = getComputedStyle(document.documentElement);
            const value = style.getPropertyValue(name).trim();
            return value || fallback;
          } catch (e) {
            return fallback;
          }
        };

        // Definiere PRX_COLORS mit CSS-Variablen oder Fallbacks
        window.PRX_COLORS = {
          primary: cssVar('--color-primary-azure', '#4A90E2'),      // Soft Azure
          secondary: cssVar('--color-primary-mint', '#7ED6C1'),    // Calm Mint
          success: cssVar('--color-primary-green', '#6FCF97'),      // Soft Green
          warning: cssVar('--color-primary-amber', '#F2C94C'),      // Soft Amber
          danger: cssVar('--color-primary-coral', '#EB5757'),       // Soft Coral
          info: '#0EA5E9',
          neutralDark: cssVar('--color-text-dark', '#2D3A45'),
          neutralMedium: cssVar('--color-text-light', '#7A8A99'),
          neutralLight: 'rgba(45, 58, 69, 0.1)',
          palette: [
            cssVar('--color-primary-azure', '#4A90E2'),
            cssVar('--color-primary-mint', '#7ED6C1'),
            cssVar('--color-primary-green', '#6FCF97'),
            cssVar('--color-primary-amber', '#F2C94C'),
            cssVar('--color-primary-coral', '#EB5757')
          ],
          paletteLight: [
            'rgba(74, 144, 226, 0.12)',   // Soft Azure
            'rgba(126, 214, 193, 0.12)', // Calm Mint
            'rgba(111, 207, 151, 0.12)', // Soft Green
            'rgba(242, 201, 76, 0.12)',  // Soft Amber
            'rgba(235, 87, 87, 0.12)'    // Soft Coral
          ]
        };
      })();

      // Animate progress bars set by template (adds .animated and applies widths)
      setTimeout(() => {
        document.querySelectorAll('.prx-progress').forEach(p => p.classList.add('animated'));
        document.querySelectorAll('.prx-progress__bar').forEach(bar => {
          const w = Number(bar.dataset.width || bar.getAttribute('data-width') || 0);
          bar.style.width = Math.max(0, Math.min(100, w)) + '%';
          const bg = bar.dataset.bg || bar.getAttribute('data-bg');
          if (bg) bar.style.background = bg;
        });
      }, 120);
    </script>

    <script>
      (function () {
        const infoButtons = document.querySelectorAll('.prx-info-btn');
        if (!infoButtons.length) {
          return;
        }

        const tooltip = document.createElement('div');
        tooltip.className = 'prx-info-tooltip';
        document.body.appendChild(tooltip);

        const showTooltip = (btn) => {
          const info = btn.getAttribute('data-info') || '';
          if (!info) return;
          tooltip.textContent = info;
          const rect = btn.getBoundingClientRect();
          const left = Math.min(rect.left, window.innerWidth - 260);
          const top = rect.top - 8;
          tooltip.style.left = `${Math.max(8, left)}px`;
          tooltip.style.top = `${Math.max(8, top - tooltip.offsetHeight)}px`;
          tooltip.classList.add('is-visible');
        };

        const hideTooltip = () => tooltip.classList.remove('is-visible');

        infoButtons.forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
          });
          btn.addEventListener('mouseenter', () => showTooltip(btn));
          btn.addEventListener('mouseleave', hideTooltip);
          btn.addEventListener('blur', hideTooltip);
        });

        // Modal for detailed info on double click
        let modal = document.getElementById('prx-info-modal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'prx-info-modal';
          modal.style.cssText = 'position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px;';
          modal.innerHTML = `
            <div style="background:#fff;border-radius:12px;padding:16px;max-width:520px;width:100%;box-shadow:0 12px 30px rgba(15,23,42,0.2);">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                <div data-role="title" style="font-weight:600;font-size:16px;">Info</div>
                <button data-role="close" type="button" style="border:0;background:transparent;font-size:20px;line-height:1;cursor:pointer;color:#6b7280;">×</button>
              </div>
              <div data-role="body" style="margin-top:8px;color:#334155;white-space:pre-line;"></div>
            </div>
          `;
          document.body.appendChild(modal);
        }

        const modalTitle = modal.querySelector('[data-role="title"]');
        const modalBody = modal.querySelector('[data-role="body"]');
        const closeBtn = modal.querySelector('[data-role="close"]');

        const closeModal = () => {
          modal.style.display = 'none';
        };
        if (closeBtn) {
          closeBtn.addEventListener('click', closeModal);
        }
        modal.addEventListener('click', (event) => {
          if (event.target === modal) closeModal();
        });

        infoButtons.forEach((btn) => {
          btn.addEventListener('dblclick', (event) => {
            event.preventDefault();
            event.stopPropagation();
            const title = btn.getAttribute('data-title') || 'Info';
            const detail = btn.getAttribute('data-detail') || btn.getAttribute('data-info') || '';
            if (modalTitle) modalTitle.textContent = title;
            if (modalBody) modalBody.textContent = detail;
            modal.style.display = 'flex';
          });
        });
      })();
    </script>

    {% block inline_scripts %}{% endblock %}
</body>
</html>