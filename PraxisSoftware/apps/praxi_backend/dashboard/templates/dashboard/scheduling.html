{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block chart_js %}
<!-- Chart.js f√ºr Scheduling-Diagramme -->
<script src="{% static 'vendor/chartjs/chart.umd.min.js' %}"></script>
{% endblock %}

{% block title %}Terminplanung KPIs{% endblock %}
{% block header_title %}PraxiApp - Terminplanung KPIs{% endblock %}
{% block nav_active_scheduling %}prx-header__link--active{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'css/pages/haupt_dashboard.css' %}?v=4.0">
{% endblock %}

{% block page_header %}
<section class="prx-section">
    <div class="prx-section__header">
        <div>
            <h1 class="prx-section__title">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false">
                        <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zM7 12h5v5H7v-5z"/>
                    </svg>
                </span>
                Terminplanung KPIs
            </h1>
            <p class="prx-section__subtitle">
                Effizienz, Auslastung und Buchungsmetriken
            </p>
        </div>
        <div class="prx-flex prx-gap-3">
            <a href="{% url 'dashboard:index' %}" class="prx-btn prx-btn--secondary">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </span>
                Haupt-Dashboard
            </a>
            <button class="prx-btn prx-btn--primary" onclick="location.reload()">
                <span class="fluent-icon" aria-hidden>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                </span>
                Aktualisieren
            </button>
        </div>
    </div>
</section>
{% endblock %}

{% block kpi_section %}
<!-- Efficiency Score -->
<section class="prx-section">
    <div class="prx-content-grid prx-content-grid--2-cols">
        <div class="prx-card" style="text-align: center;">
            <div class="prx-card__body" style="position: relative;">
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Effizienz-Score"
                    data-info="Zusammenfassung aus Abschluss-, No-Show- und Stornoquoten."
                    data-detail="Der Score kombiniert mehrere Metriken zur Effizienz der Terminplanung. Hoehere Werte sind besser."
                    aria-label="Info zum Effizienz-Score"
                    style="position:absolute; top: 12px; right: 12px;"
                >i</span>
                <div style="font-size: 4rem; font-weight: 700; color: {% if kpis.efficiency_score >= 80 %}var(--color-primary-green){% elif kpis.efficiency_score >= 60 %}var(--color-primary-amber){% else %}var(--color-primary-coral){% endif %};">
                    {{ kpis.efficiency_score }}
                </div>
                <div class="prx-text-sm prx-font-semibold prx-text-muted" style="margin-top: var(--spacing-2);">Effizienz-Score</div>
                <div class="prx-badge prx-badge--{% if kpis.efficiency_score >= 80 %}success{% elif kpis.efficiency_score >= 60 %}warning{% else %}danger{% endif %}" style="margin-top: var(--spacing-3);">
                    {% if kpis.efficiency_score >= 80 %}Exzellent{% elif kpis.efficiency_score >= 60 %}Gut{% else %}Verbesserungspotenzial{% endif %}
                </div>
            </div>
        </div>
        
        <div>
            <div class="prx-kpi-grid">
            <!-- Completion Rate -->
            <div class="prx-kpi prx-kpi--success">
            <div class="prx-kpi__label">
                Completion Rate
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Completion Rate"
                    data-info="Anteil abgeschlossener Termine."
                    data-detail="Completion Rate = abgeschlossen / gesamt."
                    aria-label="Info zu Completion Rate"
                >i</span>
            </div>
                <div class="prx-kpi__value">{{ kpis.completion_rate.rate }}<span class="prx-kpi__unit">%</span></div>
                <div class="prx-kpi__description">{{ kpis.completion_rate.completed }} / {{ kpis.completion_rate.total }} Termine</div>
            </div>
            
            <!-- Cancellation Rate -->
            <div class="prx-kpi prx-kpi--{% if kpis.cancellation.cancellation_rate > 20 %}danger{% elif kpis.cancellation.cancellation_rate > 10 %}warning{% else %}success{% endif %}">
            <div class="prx-kpi__label">
                Stornoquote
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Stornoquote"
                    data-info="Anteil stornierter Termine."
                    data-detail="Stornoquote = storniert / gesamt."
                    aria-label="Info zu Stornoquote"
                >i</span>
            </div>
                <div class="prx-kpi__value">{{ kpis.cancellation.cancellation_rate }}<span class="prx-kpi__unit">%</span></div>
                <div class="prx-kpi__description">{{ kpis.cancellation.cancelled_count }} Stornierungen</div>
            </div>
            
            <!-- No-Show Rate -->
            <div class="prx-kpi prx-kpi--{% if kpis.no_show_rate.rate > 15 %}danger{% elif kpis.no_show_rate.rate > 8 %}warning{% else %}success{% endif %}">
            <div class="prx-kpi__label">
                No-Show Rate
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="No-Show Rate"
                    data-info="Anteil nicht wahrgenommener Termine."
                    data-detail="No-Show Rate = No-Shows / (abgeschlossen + No-Shows)."
                    aria-label="Info zu No-Show Rate"
                >i</span>
            </div>
                <div class="prx-kpi__value">{{ kpis.no_show_rate.rate }}<span class="prx-kpi__unit">%</span></div>
                <div class="prx-kpi__description">{{ kpis.no_show_rate.no_show }} von {{ kpis.no_show_rate.total }}</div>
            </div>
            
            <!-- Average Lead Time -->
            <div class="prx-kpi prx-kpi--info">
            <div class="prx-kpi__label">
                √ò Vorlaufzeit
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="√ò Vorlaufzeit"
                    data-info="Durchschnittliche Tage zwischen Buchung und Termin."
                    data-detail="Je hoeher, desto laenger planen Patient:innen im Voraus."
                    aria-label="Info zu √ò Vorlaufzeit"
                >i</span>
            </div>
                <div class="prx-kpi__value">{{ kpis.lead_time.avg_days }}<span class="prx-kpi__unit">Tage</span></div>
                <div class="prx-kpi__description">Min: {{ kpis.lead_time.min_days }}d / Max: {{ kpis.lead_time.max_days }}d</div>
            </div>
            
            <!-- Avg Duration -->
            <div class="prx-kpi prx-kpi--primary">
            <div class="prx-kpi__label">
                √ò Termindauer
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="√ò Termindauer"
                    data-info="Durchschnittliche Dauer eines Termins."
                    data-detail="Zeigt die mittlere Terminlaenge in Minuten."
                    aria-label="Info zu √ò Termindauer"
                >i</span>
            </div>
                <div class="prx-kpi__value">{{ kpis.avg_duration }}<span class="prx-kpi__unit">min</span></div>
            </div>
            
            <!-- New Patients -->
            <div class="prx-kpi prx-kpi--accent">
            <div class="prx-kpi__label">
                Neupatient-Quote
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Neupatient-Quote"
                    data-info="Anteil neuer Patient:innen."
                    data-detail="Neupatient-Quote = neue Patient:innen / gesamt."
                    aria-label="Info zu Neupatient-Quote"
                >i</span>
            </div>
                <div class="prx-kpi__value">{{ kpis.new_patient.rate }}<span class="prx-kpi__unit">%</span></div>
                <div class="prx-kpi__description">{{ kpis.new_patient.new_patient_count }} neue Patienten</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Booking Funnel Section -->
<section class="prx-section">
    <div class="prx-card__header" style="margin-bottom: var(--spacing-4);">
        <h2 class="prx-card__title">
            <span class="prx-card__title-icon">üìä</span>
            Buchungs-Funnel
        </h2>
    </div>
    
    <div class="prx-content-grid--2-cols prx-content-grid">
        <!-- Funnel Visualization -->
        <div class="prx-card">
            <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
                <h3 class="prx-card__title">Terminverlauf</h3>
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Terminverlauf"
                    data-info="Funnel der Terminphasen."
                    data-detail="Zeigt den Verlauf von gebucht bis abgeschlossen, inklusive Drop-offs."
                    aria-label="Info zu Terminverlauf"
                >i</span>
            </div>
            <div class="prx-card__body" id="funnelContainer" style="display: flex; flex-direction: column; gap: var(--spacing-3);">
                <p class="text-muted text-sm prx-text-center prx-chart-placeholder">Funnel l√§dt‚Ä¶</p>
            </div>
        </div>
        
        <!-- Trend Chart -->
        <div class="prx-card">
            <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
                <h3 class="prx-card__title">üìà Entwicklung</h3>
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Entwicklung"
                    data-info="Trends bei Abschluss-, No-Show- und Stornorate."
                    data-detail="Zeitverlauf der wichtigsten Quoten im Zeitraum."
                    aria-label="Info zu Entwicklung"
                >i</span>
            </div>
            <div class="prx-card__body">
                <div class="prx-chart-container prx-chart-container--md">
                    <div class="text-muted text-sm prx-text-center prx-chart-placeholder">Diagramm l√§dt‚Ä¶</div>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Booking Stats Section -->
<section class="prx-section">
    <div class="prx-content-grid--2-cols prx-content-grid">
        <!-- Booking Stats -->
        <div class="prx-card">
            <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
                <h3 class="prx-card__title">üìã Buchungsstatistik</h3>
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Buchungsstatistik"
                    data-info="Summen der Buchungsstatus."
                    data-detail="Zeigt die Anzahl gebuchter, bestaetigter und stornierter Termine."
                    aria-label="Info zu Buchungsstatistik"
                >i</span>
            </div>
            <div class="prx-card__body">
                <div class="flex gap-4" style="flex-wrap: wrap; text-align: center;">
                    <div class="prx-stat" style="flex: 1; min-width: 80px;">
                        <span class="prx-stat__label">Gebucht</span>
                        <span class="prx-stat__value prx-stat__value--primary">{{ kpis.new_patient.total_appointments }}</span>
                    </div>
                    <div class="prx-stat" style="flex: 1; min-width: 80px;">
                        <span class="prx-stat__label">Best√§tigt</span>
                        <span class="prx-stat__value prx-stat__value--success">{{ kpis.completion_rate.completed }}</span>
                    </div>
                    <div class="prx-stat" style="flex: 1; min-width: 80px;">
                        <span class="prx-stat__label">Storniert</span>
                        <span class="prx-stat__value prx-stat__value--danger">{{ kpis.cancellation.cancelled_count }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Lead Time Distribution -->
        <div class="prx-card">
            <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
                <h3 class="prx-card__title">‚è±Ô∏è Vorlaufzeit-Verteilung</h3>
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Vorlaufzeit-Verteilung"
                    data-info="Wie lange im Voraus Termine gebucht werden."
                    data-detail="Verteilung der Buchungen nach Vorlaufzeit-Klassen."
                    aria-label="Info zu Vorlaufzeit-Verteilung"
                >i</span>
            </div>
            <div class="prx-card__body">
                <div class="prx-chart-container prx-chart-container--md">
                    <div class="text-muted text-sm prx-text-center prx-chart-placeholder">Diagramm l√§dt‚Ä¶</div>
                    <canvas id="leadTimeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Capacity Utilization Section -->
<section class="prx-section">
    <h2 class="prx-section__title" style="margin-bottom: var(--spacing-4); display: flex; align-items: center; gap: var(--spacing-2);">
        <span>üë•</span> Kapazit√§tsauslastung
        <span
            class="prx-info-btn"
            role="button"
            tabindex="0"
            data-title="Kapazit√§tsauslastung"
            data-info="Auslastung von Behandlern und Raeumen."
            data-detail="Uebersicht der Kapazitaetsauslastung je Behandler und Raum im Zeitraum."
            aria-label="Info zu Kapazit√§tsauslastung"
        >i</span>
    </h2>
    
    <div class="prx-content-grid--2-cols prx-content-grid">
        <!-- Doctor Utilization -->
        <div class="prx-card">
            <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
                <h3 class="prx-card__title">
                    <span class="prx-card__title-icon">üë®‚Äç‚öïÔ∏è</span>
                    Behandler-Auslastung
                </h3>
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Behandler-Auslastung"
                    data-info="Auslastung je Behandler in Prozent."
                    data-detail="Basierend auf geplanten Terminen und gebuchter Zeit im Zeitraum."
                    aria-label="Info zur Behandler-Auslastung"
                >i</span>
            </div>
            <div class="prx-card__body">
                {% for doc in kpis.doctor_utilization %}
                <div class="prx-list-item" style="border: none; padding: var(--spacing-3) 0;">
                    <div class="prx-avatar prx-avatar--md" style="background: {{ doc.color }}; color: white;">
                        {{ doc.name|slice:":2"|upper }}
                    </div>
                    <div class="prx-list-item__content">
                        <div class="prx-list-item__title">{{ doc.name }}</div>
                        <div class="prx-list-item__subtitle">{{ doc.appointments }} Termine ‚Ä¢ {{ doc.booked_mins|floatformat:0 }} min</div>
                    </div>
                    <div style="flex: 1; max-width: 150px;">
                        <div class="prx-progress">
                            <div class="prx-progress__bar" style="width: {{ doc.utilization }}%; background: {{ doc.color }};"></div>
                        </div>
                    </div>
                    <span class="font-semibold text-sm" style="color: {{ doc.color }}; min-width: 45px; text-align: right;">{{ doc.utilization }}%</span>
                </div>
                {% empty %}
                <p class="text-muted text-sm prx-text-center">Keine √Ñrzte konfiguriert</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Room Utilization -->
        <div class="prx-card">
            <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
                <h3 class="prx-card__title">
                    <span class="prx-card__title-icon">üö™</span>
                    Raum-Auslastung
                </h3>
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Raum-Auslastung"
                    data-info="Auslastung je Raum in Prozent."
                    data-detail="Zeigt die belegte Zeit pro Raum im Zeitraum."
                    aria-label="Info zur Raum-Auslastung"
                >i</span>
            </div>
            <div class="prx-card__body">
                {% for room in kpis.room_utilization %}
                <div class="prx-list-item" style="border: none; padding: var(--spacing-3) 0;">
                    <div class="prx-avatar prx-avatar--md" style="background: {{ room.color }}; color: white;">üö™</div>
                    <div class="prx-list-item__content">
                        <div class="prx-list-item__title">{{ room.name }}</div>
                        <div class="prx-list-item__subtitle">{{ room.appointments }} Buchungen ‚Ä¢ {{ room.booked_mins|floatformat:0 }} min</div>
                    </div>
                    <div style="flex: 1; max-width: 150px;">
                        <div class="prx-progress">
                            <div class="prx-progress__bar" style="width: {{ room.utilization }}%; background: {{ room.color }};"></div>
                        </div>
                    </div>
                    <span class="font-semibold text-sm" style="color: {{ room.color }}; min-width: 45px; text-align: right;">{{ room.utilization }}%</span>
                </div>
                {% empty %}
                <p class="text-muted text-sm prx-text-center">Keine R√§ume konfiguriert</p>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<!-- Peak Load Section -->
<section class="prx-section" id="peak-load">
    <h2 class="prx-section__title" style="margin-bottom: var(--spacing-4); display: flex; align-items: center; gap: var(--spacing-2);">
        <span>üî•</span> Peak-Load Analyse
        <span
            class="prx-info-btn"
            role="button"
            tabindex="0"
            data-title="Peak-Load Analyse"
            data-info="Spitzenlasten nach Stunde und Wochentag."
            data-detail="Zeigt Spitzenzeiten und Auslastungsmuster, um Engpaesse zu erkennen."
            aria-label="Info zu Peak-Load Analyse"
        >i</span>
    </h2>
    
    <div class="prx-content-grid--2-cols prx-content-grid">
        <!-- Hourly Load -->
        <div class="prx-card">
            <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
                <h3 class="prx-card__title">üïê Termine pro Stunde</h3>
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Termine pro Stunde"
                    data-info="Anzahl Termine je Stunde."
                    data-detail="Zeigt, in welchen Stunden die meisten Termine stattfinden."
                    aria-label="Info zu Termine pro Stunde"
                >i</span>
            </div>
            <div class="prx-card__body">
                <div class="prx-chart-container prx-chart-container--sm">
                    <div class="text-muted text-sm prx-text-center prx-chart-placeholder">Diagramm l√§dt‚Ä¶</div>
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Weekday Load -->
        <div class="prx-card">
            <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
                <h3 class="prx-card__title">üìÖ Termine pro Wochentag</h3>
                <span
                    class="prx-info-btn"
                    role="button"
                    tabindex="0"
                    data-title="Termine pro Wochentag"
                    data-info="Anzahl Termine je Wochentag."
                    data-detail="Vergleicht die Auslastung ueber die Wochentage."
                    aria-label="Info zu Termine pro Wochentag"
                >i</span>
            </div>
            <div class="prx-card__body">
                <div class="prx-chart-container prx-chart-container--sm">
                    <div class="text-muted text-sm prx-text-center prx-chart-placeholder">Diagramm l√§dt‚Ä¶</div>
                    <canvas id="weekdayChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Heatmap -->
    <div class="prx-card" style="margin-top: var(--spacing-6);">
        <div class="prx-card__header" style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-2);">
            <h3 class="prx-card__title">
                <span class="prx-card__title-icon">üóìÔ∏è</span>
                Auslastungs-Heatmap (Stunde √ó Wochentag)
            </h3>
            <span
                class="prx-info-btn"
                role="button"
                tabindex="0"
                data-title="Auslastungs-Heatmap"
                data-info="Heatmap der Auslastung pro Stunde und Wochentag."
                data-detail="Dunklere Felder bedeuten hoehere Auslastung."
                aria-label="Info zur Auslastungs-Heatmap"
            >i</span>
        </div>
        <div class="prx-card__body">
            <div class="prx-table-wrapper" style="border: none;">
                <table class="prx-table prx-table--compact" id="heatmapTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>07</th><th>08</th><th>09</th><th>10</th><th>11</th><th>12</th>
                            <th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th>
                        </tr>
                    </thead>
                    <tbody id="heatmapBody">
                        <tr>
                            <td class="text-muted text-sm prx-text-center prx-chart-placeholder" colspan="14">Heatmap l√§dt‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Legend -->
            <div class="flex gap-4 justify-center" style="margin-top: var(--spacing-4);">
                <div class="flex items-center gap-1">
                    <div style="width: 16px; height: 16px; border-radius: var(--radius-sm); background: var(--color-neutral-200);"></div>
                    <span class="text-xs text-muted">Keine</span>
                </div>
                <div class="flex items-center gap-1">
                    <div style="width: 16px; height: 16px; border-radius: var(--radius-sm); background: rgba(47, 111, 171, 0.3);"></div>
                    <span class="text-xs text-muted">Niedrig</span>
                </div>
                <div class="flex items-center gap-1">
                    <div style="width: 16px; height: 16px; border-radius: var(--radius-sm); background: rgba(47, 111, 171, 0.6);"></div>
                    <span class="text-xs text-muted">Mittel</span>
                </div>
                <div class="flex items-center gap-1">
                    <div style="width: 16px; height: 16px; border-radius: var(--radius-sm); background: rgba(47, 111, 171, 0.9);"></div>
                    <span class="text-xs text-muted">Hoch</span>
                </div>
                <div class="flex items-center gap-1">
                    <div style="width: 16px; height: 16px; border-radius: var(--radius-sm); background: var(--color-danger-500);"></div>
                    <span class="text-xs text-muted">Peak</span>
                </div>
            </div>
            
            <p class="prx-text-center text-secondary text-sm" style="margin-top: var(--spacing-4);">
                üî• Peak: <strong>{{ kpis.peak_load.peak_day }} um {{ kpis.peak_load.peak_hour }}:00 Uhr</strong> 
                ({{ kpis.peak_load.peak_count }} Termine)
            </p>
        </div>
    </div>
</section>

<!-- Last Updated -->
<div class="prx-text-center text-muted text-sm" style="margin-top: var(--spacing-6);">
    Zuletzt aktualisiert: {{ kpis.generated_at|slice:":19"|default:"Jetzt" }}
</div>
{% endblock %}

{% block inline_scripts %}
<script type="application/json" id="scheduling-charts-json">
{{ charts_json|default:"{}"|safe }}
</script>
<script type="application/json" id="scheduling-heatmap-json">
{{ heatmap_matrix|default:"[]"|safe }}
</script>
<script type="application/json" id="scheduling-funnel-json">
{{ funnel_data|default:"{}"|safe }}
</script>
<script>
(() => {
  const chartsJson = document.getElementById("scheduling-charts-json");
  const heatmapJson = document.getElementById("scheduling-heatmap-json");
  const funnelJson = document.getElementById("scheduling-funnel-json");
  if (!chartsJson || !heatmapJson || !funnelJson) {
    return;
  }

  const parseJson = (raw, fallback) => {
    if (!raw) return fallback;
    try {
      return JSON.parse(raw);
    } catch (err) {
      return fallback;
    }
  };

  const chartsData = parseJson(chartsJson.textContent, {});
  const heatmapMatrix = parseJson(heatmapJson.textContent, []);
  const funnelData = parseJson(funnelJson.textContent, {});

  if (!window.PRX_COLORS) {
    window.PRX_COLORS = {
      primary: "#4A90E2",
      secondary: "#7ED6C1",
      success: "#6FCF97",
      warning: "#F2C94C",
      danger: "#EB5757",
      info: "#0EA5E9",
      neutralDark: "#2D3A45",
      neutralMedium: "#7A8A99",
      neutralLight: "rgba(45, 58, 69, 0.1)",
      palette: ["#4A90E2", "#7ED6C1", "#6FCF97", "#F2C94C", "#EB5757"],
      paletteLight: [
        "rgba(74, 144, 226, 0.12)",
        "rgba(126, 214, 193, 0.12)",
        "rgba(111, 207, 151, 0.12)",
        "rgba(242, 201, 76, 0.12)",
        "rgba(235, 87, 87, 0.12)",
      ],
    };
  }
  const PRX_COLORS = window.PRX_COLORS;

  const clearPlaceholder = (container) => {
    container?.querySelectorAll(".prx-chart-placeholder").forEach((el) => el.remove());
  };

  const renderMessage = (canvasId, message) => {
    const el = document.getElementById(canvasId);
    const container = el?.parentElement;
    if (container) {
      clearPlaceholder(container);
      container.innerHTML = `<p class="text-muted text-sm prx-text-center">${message}</p>`;
    }
  };

  const renderChart = (canvasId, config) => {
    if (!window.Chart || !config?.data) {
      renderMessage(canvasId, "Chartdaten fehlen");
      return;
    }
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
      return;
    }
    clearPlaceholder(canvas.parentElement);
    new Chart(canvas, config);
  };

  if (chartsData.completion_rate_trend?.datasets) {
    chartsData.completion_rate_trend.datasets.forEach((ds, i) => {
      ds.borderColor = PRX_COLORS.palette[i];
      ds.backgroundColor = PRX_COLORS.paletteLight[i];
      ds.fill = true;
    });
  }

  if (chartsData.lead_time_distribution?.datasets?.[0]) {
    chartsData.lead_time_distribution.datasets[0].backgroundColor = PRX_COLORS.primary;
  }

  if (chartsData.hourly_load?.datasets?.[0]) {
    chartsData.hourly_load.datasets[0].backgroundColor = PRX_COLORS.primary;
  }

  if (chartsData.weekday_load?.datasets?.[0]) {
    chartsData.weekday_load.datasets[0].backgroundColor = PRX_COLORS.palette;
  }

  renderChart("trendChart", {
    type: "line",
    data: chartsData.completion_rate_trend,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "bottom", labels: { boxWidth: 12, padding: 16 } },
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: { callback: (v) => `${v}%` },
          grid: { color: PRX_COLORS.neutralLight },
        },
        x: { grid: { display: false } },
      },
    },
  });

  renderChart("leadTimeChart", {
    type: "bar",
    data: chartsData.lead_time_distribution,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: PRX_COLORS.neutralLight } },
        x: { grid: { display: false } },
      },
    },
  });

  renderChart("hourlyChart", {
    type: "bar",
    data: chartsData.hourly_load,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: PRX_COLORS.neutralLight } },
        x: { grid: { display: false } },
      },
    },
  });

  renderChart("weekdayChart", {
    type: "bar",
    data: chartsData.weekday_load,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: PRX_COLORS.neutralLight } },
        x: { grid: { display: false } },
      },
    },
  });

  const funnelContainer = document.getElementById("funnelContainer");
  const maxFunnel = funnelData.total || 1;
  const funnelColors = [
    PRX_COLORS.primary,
    PRX_COLORS.secondary,
    PRX_COLORS.success,
    PRX_COLORS.neutralMedium,
  ];

  if (Array.isArray(funnelData.funnel)) {
    clearPlaceholder(funnelContainer);
    funnelData.funnel.forEach((stage, idx) => {
      const width = Math.max(30, (stage.count / maxFunnel) * 100);
      const rate =
        idx > 0
          ? Math.round((stage.count / funnelData.funnel[idx - 1].count) * 100)
          : 100;
      const color = funnelColors[idx] || PRX_COLORS.neutralMedium;

      funnelContainer.innerHTML += `
        <div style="display: flex; align-items: center; gap: var(--spacing-3);">
          <span class="text-sm font-medium" style="width: 100px;">${stage.stage}</span>
          <div style="flex: 1; height: 32px; background: var(--color-neutral-100); border-radius: var(--radius-lg); overflow: hidden; position: relative;">
            <div style="width: ${width}%; height: 100%; background: ${color}; display: flex; align-items: center; justify-content: space-between; padding: 0 var(--spacing-3); color: white; font-size: var(--font-size-sm); font-weight: 600;">
              <span>${stage.count}</span>
              <span>${rate}%</span>
            </div>
          </div>
        </div>
      `;
    });
  } else if (funnelContainer) {
    clearPlaceholder(funnelContainer);
    funnelContainer.innerHTML = '<p class="text-muted text-sm prx-text-center">Funnel-Daten fehlen</p>';
  }

  const days = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
  const heatmapBody = document.getElementById("heatmapBody");
  const hasHeatmap = Array.isArray(heatmapMatrix) && heatmapMatrix.length >= 7;
  const maxVal = hasHeatmap ? Math.max(...heatmapMatrix.flat()) || 1 : 1;

  if (!hasHeatmap && heatmapBody) {
    clearPlaceholder(heatmapBody);
    const row = document.createElement("tr");
    row.innerHTML =
      '<td class="text-muted text-sm prx-text-center" colspan="14">Heatmap-Daten fehlen</td>';
    heatmapBody.appendChild(row);
  }

  if (hasHeatmap) {
    clearPlaceholder(heatmapBody);
    days.forEach((day, dayIdx) => {
      const row = document.createElement("tr");
      row.innerHTML = `<td class="font-semibold">${day}</td>`;

      for (let hour = 7; hour <= 19; hour++) {
        const count = heatmapMatrix[dayIdx][hour] || 0;
        const intensity = count / maxVal;

        let color;
        if (count === 0) {
          color = "var(--color-neutral-200)";
        } else if (intensity >= 0.9) {
          color = "var(--color-danger-500)";
        } else if (intensity >= 0.6) {
          color = "rgba(47, 111, 171, 0.9)";
        } else if (intensity >= 0.3) {
          color = "rgba(47, 111, 171, 0.6)";
        } else {
          color = "rgba(47, 111, 171, 0.3)";
        }

        row.innerHTML += `
          <td class="prx-text-center">
            <div style="
              width: 28px;
              height: 28px;
              border-radius: var(--radius-md);
              background: ${color};
              display: inline-flex;
              align-items: center;
              justify-content: center;
              font-size: var(--font-size-xs);
              font-weight: 500;
              color: ${count > 0 ? "white" : "var(--text-muted)"};
            " title="${day} ${hour}:00 - ${count} Termine">
              ${count > 0 ? count : ""}
            </div>
          </td>
        `;
      }

      heatmapBody.appendChild(row);
    });
  }
})();
</script>
{% endblock %}
